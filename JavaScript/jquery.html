<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no" />
    <title>ImageGuru</title>
    <style>
        img {
            width: 300px;
            height: 400px;
            margin: 10px;
            background-size: cover;
            background-repeat: no-repeat;
            background-position: 50% 50%;
        }
    </style>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
</head>
<body>
    <h1>Setup</h1>
    <p>
        API key
        <input type="text" id="apiKey" style="width: 280px" /><br />
        Go <a href="https://market.mashape.com/veezeon/imageguru" target="_blank">here</a> to get one
    </p>
    <h1>Query image</h1>
    <p>Take a photo of one of available images below</p>
    <input type="file" accept="image/*" id="imageToQuery">
    <h4 id="result"></h4>

    <h1>Available images</h1>
    <input type="button" value="Load" id="loadImagesButton" />
    <div id="images">

    </div>

    <script>

        (function () {

            var uri = "https://veezeon-image-recognition-v1.p.mashape.com/";

            var key = document.cookie.substr(4);
            $("#apiKey").val(key);

            function handleError() {
                alert("An error has occurred");
            }

            function addHeader(xhr) {
                var key = $("#apiKey").val();
                document.cookie = "key=" + key;
                xhr.setRequestHeader("X-Mashape-Key", key);
            }

            function loadImage(img, id) {
                var xhr = new XMLHttpRequest();
                xhr.open("GET", uri + "catalog/" + id + "?index=0", true);
                addHeader(xhr);
                xhr.responseType = 'blob';

                xhr.onload = function (e) {
                    if (this.status === 200) {
                        img.style.backgroundImage = "url(" + URL.createObjectURL(this.response) + ")";
                    } else {
                        handleError(this);
                    }
                };

                xhr.send();
            }

            function loadImages() {
                var xhr = new XMLHttpRequest();
                xhr.open("GET", uri + "catalog", true);
                addHeader(xhr);

                xhr.onload = function (e) {
                    if (this.status === 200) {
                        var result = JSON.parse(this.responseText);
                        var $images = $("#images");
                        $.each(result,
                            function (index, item) {
                                var $img = $("<img />")
                                    .attr({
                                        title: item
                                    })
                                    .appendTo($images);

                                loadImage($img.get(0), item);
                            });
                    } else {
                        handleError(this);
                    }
                }
                xhr.send();
            }
            function queryImage() {
                if (this.files.length > 0 && this.files[0].size > 0) {
                    var $result = $("#result");
                    $result.text("Searching...");

                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", uri + "query", true);
                    addHeader(xhr);

                    xhr.onload = function (e) {
                        if (this.status === 200) {
                            $result.text("ciao");
                        } else if (this.status === 404) {
                            $result.text("Not found");
                        } else {
                            $result.text("");
                            handleError(this);
                        }
                    };

                    xhr.send(this.files[0]);
                }
            }

            $("#loadImagesButton").click(loadImages);
            $("#imageToQuery").change(queryImage);
        })();

    </script>

</body>
</html>